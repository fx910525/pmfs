\section{Quadratic estimator formalism}
\label{sec:estimators}

We now derive an unbiased minimum-variance quadratic estimator for a cosmic magnetic field $\vec B$, following a formalism similar to what is used in CMB studies \cite{2003PhRvD..67h3002O}. We first assume that the field is uniform across the survey volume, and only evolves with redshift due to the expansion of the universe as 
\beq
B(z) = B_0(1+z)^2,
\label{eq:B0}
\eeq
where $B_0$ represents its present-day value (or equivalently, its value in comoving units); the relevant estimator is denoted y a hat sign, $\widehat B_0$. Then we move on to the case of a stochastic magnetic field, with a given power spectrum $P_B(\vec K)$ where $\vec K$ denotes the wavevector for the mode of the field; in this case, the relevant estimator is of its amplitude, $\widehat A_0$. In both cases, the presented formalism is only valid if there the following separation is scales is saticefied: density-field modes in consideration must have much smaller wavelengths than the coherence scale of the magnetic field (or a given mode of a stochastic magnetic field), and both must be smaller than the size of the tomography survey at hand.

\subsection{Uniform field}
\label{subsec:uniform}

We first derive an unbiased minimum-variance quadratic estimator $\widehat B_0$ for a comoving uniform magnetic field. We start by noting that the redshifted 21-cm brightness temperature Fourier modes $T(\vec k)$ contain contribution from the noise $T^N(\vec k)$ and the signal $T^S(\vec k)$, where the signal is contains contributions from the 21-cm signal with no magnetic field (null-case signal $T^S_0(\vec k)$), and with the magnetic field, 
\beq
\bga
T(\vec k) = T^N(\vec k) + T^S(\vec k),\\
T^S(\vec k) = T^S_0(\vec k) + B_0\frac{\partial T^S_0}{\partial B_0}(\vec k),%\bigg|_{B=0},
\ega
\label{eq:Ttot}
\eeq
where $B$ is a small expansion parameter (we adopt the linear-theory approach throught this work). We use the subscript ``0'' to denote functions evaluated at $B=0$. Temperature is proportional to is the density fluctuation $\delta$, with the transfer funtion $G({\bf{\widehat k}})$ as the proportionality factor,
\beq
\bga
T^S(\vec k) = G({\bf{\widehat k}})\delta(k),\\
T^S_0(\vec k) = G_0({\bf{\widehat k}})\delta(k),
\ega
\label{eq:def_G}
\eeq
where ${\bf{\widehat k}}=(\theta_k,\phi_k)$ is a unit vector in the direction of $\vec k$. Note that while $G$ is a function of the direction vector ${\bf{\widehat k}}$ only, the power spectrum $P_\delta$ is a function of the magnitude $k$, in an isotropic universe. For simplicity of the expressions, we adopt the following notation
\beq
\bga
\frac{\partial T_0^S}{\partial B_0}(\vec k)\equiv  \delta(k)\frac{\partial G}{\partial B_0}({\bf{\widehat k}},B_0=0),\\
\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})\equiv\frac{\partial G}{\partial B_0}({\bf{\widehat k}},B_0=0)
\ega
\label{eq:dTdB_dGdB}
\eeq
Furthermore, we denote the power spectrum in the null case as
\beq
P_\text{null}(\vec k) \equiv P^N(\vec k) + P_0^S(\vec k).
\label{eq:Pnull}
\eeq
The signal power spectrum in the absence of a magnetic fields is given as
\beq
\bga
\left<T_0(\vec k)T_0^*(\vec k')\right> \equiv (2\pi)^3 \delta_D(\vec k-\vec k') P_0^S(\vec k)\\
= (2\pi)^3 \delta_D(\vec k-\vec k')G^2_0({\bf{\widehat k}})P_\delta(k),
\ega
\eeq
where 
\beq
\bga
\left<\delta(\vec k)\delta^*(\vec k')\right> \equiv (2\pi)^3 \delta_D(\vec k-\vec k') P_\delta(k).
\ega
\eeq

The observable 2-point correlation function in Fourier space is
\beq
\bga
\langle T(\vec k)T^*(\vec k')\rangle = P_\text{null}(\vec k)(2\pi)^3\delta_D(\vec k-\vec k') \\
+ \langle T^S_0(\vec k)B_0\frac{\partial T_0^{S,*}}{\partial B_0}(\vec k')\rangle + \langle T_0^{S,*}(\vec k')B_0\frac{\partial T_0^S}{\partial B_0}(\vec k)\rangle\\
=\left(P_\text{null}(\vec k)
 + 2B_0P_{\delta}( k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}}) \right) \\\times(2\pi)^3\delta_D(\vec k-\vec k'),
\ega
\label{eq:TT_step2}
\eeq
where we assume that the signal and the noise are uncorrelated and keep only terms linear in $B_0$; note also that $G$ and $\partial G/\partial B_0$ are real quantities.
%Notice here that, unlike the case of a uniform magnetic field, a stochastic field introduces cross correlations between otherwise independent Fourier modes in the brightness temperature signal. This produces the characteristic statistical-anisotropy signal that is a telltale signatrure of the magnetic fields \text{in situ} at high redshift.

Since we observe only one universe, the measured proxy for the ensamble average in \eq{\ref{eq:TT_step2}} is the product $T(\vec k)T^*(\vec k)$. Using \eq{\ref{eq:TT_step2}}, each $T(\vec k)$ gives an estimate for $B_0$,
\beq
\widehat B_0^{\vec k} = \frac{\frac{1}{V}T(\vec k)T^*(\vec k) - P_\text{null}(\vec k)}{2P_{\delta}( k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})},
\label{eq:hatBk}
\eeq 
where we use the following property of the Dirac delta function on a finite volume of the survey $V$
\beq
\delta_D(\vec k-\vec k') = \frac{V}{(2\pi)^3},\hspace{0.2in} \text{for }\vec k = \vec k',
\label{eq:delta_kk}
\eeq
related to the Kroneker delta,
\beq
\delta_{\vec k\vec k'} = \frac{(2\pi)^3}{V}\delta_D(\vec k-\vec k').
\label{eq:deltas}
\eeq
The estimator of \eq{\ref{eq:hatBk}} is unbiased, $\langle \widehat B_0^{\vec k}\rangle=0$. The covariance of the estimates from all available temperature-field modes $\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k'},*}\rangle $ involves temperature-field 4-point correlation with three Wick constractions; its numerator reads
\beq
\bga
\frac{1}{V^2}\langle T(\vec k)T^*(\vec k)T(\vec k')T^*(\vec k') \rangle + P_\text{null}(\vec k)P_\text{null}(\vec k')\\
- \frac{1}{V}P_\text{null}(\vec k)\langle T(\vec k')T^*(\vec k') \rangle
- \frac{1}{V}P_\text{null}(\vec k')\langle T(\vec k)T^*(\vec k) \rangle \\
= P_\text{null}(\vec k)P_\text{null}(\vec k') \left[\frac{(2\pi)^6}{V^2}\right.\delta_D(\vec k-\vec k)\delta_D(\vec k'-\vec k')\\
+\frac{(2\pi)^6}{V^2}\delta_D(\vec k-\vec k')\delta_D(\vec k-\vec k')+
\frac{(2\pi)^6}{V^2}\delta_D(\vec k+\vec k')\delta_D(\vec k+\vec k')\\
-\frac{(2\pi)^3}{V}\delta_D(\vec k'-\vec k')-\left.\frac{(2\pi)^3}{V}\delta_D(\vec k-\vec k)\right]\\
=P_\text{null}(\vec k)P_\text{null}(\vec k')\left(\delta_{\vec k,\vec k'} + \delta_{\vec k,-\vec k'}\right)
\ega
\label{eq:TTTT_expansion}
\eeq
where every ensamble average yielded one factor of $V$. Finally, we get the following expression 
\beq
\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k'},*}\rangle = \frac{P_\text{null}^2(\vec k)\left(\delta_{\vec k,\vec k'}  + \delta_{\vec k,-\vec k'} \right)}{4P_{\delta}( k)^2\left[G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})\right]^2},
\label{eq:B_covariance}
\eeq
Estimates coming from different $\vec k$-modes can be combined with inverse-variance weights in the usual way to form a minimum-variance estimator,
\beq
\bga
\widehat B_0 = \frac{\sum_{\vec k}\frac{\widehat B_0^{\vec k}}{\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k},*}\rangle}}{\sum_{\vec k}\frac{1}{\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k},*}\rangle}}.
\ega
\label{eq:B_mve}
\eeq 
The final expression for the minimum-variance quadratic estimator computed from temperature measurements at a given redshift is 
\beq
\bga
\widehat B_0 = \sigma^{2}_{\widehat B_0}\sum_{\vec k}\frac{\frac{1}{V}T(\vec k)T^*(\vec k) - P_\text{null}(\vec k)}{P_\text{null}^2(\vec k)}\\
\times 2P_{\delta}( k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}}),
\ega
\label{eq:B_estimator}
\eeq
with variance given by
\beq
\bga
\sigma^{-2}_{\widehat B_0} = \sum_{\vec k}\left(\frac{2P_{\delta}(k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})}{G^2_0({\bf{\widehat k}})P_\delta(k)+P^N(\vec k)}\right)^{2},
\ega
\label{eq:B_estimator_var}
\eeq
where the sums are over the whole $\vec k$-plane, and thus the factor of 2 coming from Kronecker deltas is removed to avoid double-counting modes. This is because $\widehat B_0^{\vec k}=\widehat B_0^{-\vec k}$, following from the reality condition on the temperature field, $T(\vec k)=T^*(\vec k)$, and the isotropy of space in the null-assumption case ($G({\bf{\widehat k}})=G(-{\bf{\widehat k}})$).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Stochastic field}
\label{subsec:SI}

We now derive a minimum-variance quadratic estimator for Fourier modes of a stochastic magnetic field. Note that in this Section we do \textit{not} assume a particular model for its power spectrum. We use $B_0$ to denote a component of $\vec B$ along one of the three Cartesian-system axes, and $\vec x$ to denote a position vector in physical space. We start with 
\beq
T^S(\vec x) = T^S_0(\vec x) + B_0(\vec x)\frac{\partial T^S_0}{\partial B_0}(\vec x),
\eeq
where the subscripts and superscripts have the same meaning as before. Note that the distinction from the uniform field case is that $B$ (and its components) is now a function of $\vec x$. We then transition to Fourier space,
\beq
\bga
T^S(\vec k) = T^S_0(\vec k) + \int d\vec x e^{-i\vec k \cdot \vec x} B_0(\vec x) \frac{\partial T^S_0}{\partial B_0}(\vec x)\\
= T^S_0(\vec k) + \frac{1}{(2\pi)^3}\int d\vec k_1B_0(\vec k_1) \frac{\partial T^S_0}{\partial B_0}(\vec k-\vec k_1),
\ega
\eeq
where $k_1$ is the integration variable, and the last step used the convolution theorem. 

In this case, the observable 2-point correlation function in Fourier space becomes
\beq
\bga
\left < T(\vec k)T^*(\vec k')\right > = P_\text{null}(\vec k)(2\pi)^3\delta_D(\vec k-\vec k')\\
+ \left <T_0^*(\vec k')\frac{1}{(2\pi)^3}\int d\vec k_1 B_0(\vec k_1) \frac{\partial T_0}{\partial B_0}(\vec k-\vec k_1)\right > \\
+ \left <T_0(\vec k)\frac{1}{(2\pi)^3}\int d\vec k_1 B_0^*(\vec k_1) \left(\frac{\partial T_0}{\partial B_0}(\vec k'-\vec k_1)\right)^*\right >, 
\ega
\eeq
to first order in $B_0$. Expanding this expression further and transitioning from Dirac to Kronecked delta in order to perform the integrals within the brakets, we get
\beq
\bga
\left< T(\vec k)T^*(\vec k')\right> = (2\pi)^3\delta_D(\vec k - \vec k')  P_\text{null}(\vec k)+B_0(\vec k - \vec k')\\
\times\left[ P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) - P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})\right],
\ega
\eeq
where we also used the reality of the $B_0$ field, $B_0^*(-\vec K) = -B_0(\vec K)$. Now, if we wish to estimate $B_0(\vec K\equiv\vec k-\vec k')$ from $\vec k,\vec k'$ pair of modes, following an analogous procedure to that used in \S\ref{subsec:uniform}, we get
\beq
\widehat B_0^{\vec k\vec k'}(\vec K) = \frac{T(\vec k)T^*(\vec k')}{P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) - P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})},
\label{eq:Bkkp_estimator}
\eeq
where we only focus on terms $\vec K\ne0$ ($\vec k \ne\vec k'$).
The variance of this estimator (evaluated under the null assumption) is 
\begin{widetext}
\begin{equation}
\left< \widehat B_0^{\vec k\vec k'}(\vec K)\left(\widehat B_0^{\vec k\vec k'}(\vec K')\right)^*\right> = 
\frac{\left<  T(\vec k)T^*(\vec k')T^*(\vec k)T(\vec k') \right>}{\left(P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) - P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k'}})\right)\left(P_\delta(k')G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k'}}) - P_\delta(k)G_0^*({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})\right)}.
\label{eq:Bkkp_var}
\end{equation}
\end{widetext}

Finally, using Eqs.~(\ref{eq:Bkkp_estimator}) and (\ref{eq:Bkkp_var}), we can derive the full estimator for the mode $B_0(\vec K)$, in the usual way (by combining the individual $\widehat B_0^{\vec k\vec k'}(\vec K)$ estimates with inverse-variance weights, and normalizing appropriately); as this is a straightforward exercise, we will not present this equation here. The null-case measurement of the power spectrum of $B_0$ is the variance of its estimator, and reads
\begin{widetext}
\beq
(2\pi)^3\delta_D(\vec K - \vec K') P^N_{B_0}(\vec K) \equiv \left< \widehat B_0(\vec K)\widehat B_0(\vec K')^*\right>
= \left( \sum_{\vec k} \frac{1}{2}\frac{\left|P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) - P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})\right|^2}{V^2\left(G^2_0({\bf{\widehat k}})P_\delta(k) + P^N(\vec k)\right)\left(G^2_0({\bf{\widehat k'}})P_\delta(k') + P^N(\vec k')\right) } \right)^{-1},
\label{eq:NK1}
\eeq
\end{widetext}
with the restriction $\vec K=\vec k-\vec k'$, and where the factor of $1/2$ serves to avoid double-counting mode pairs. As before, $P^N$ is given by Eq.~(\ref{eq:Pnoise_K}). If we limit ourselves to the diagonal terms only, $\vec K=\vec K'$, then the lhs of the above expression becomes $V P^N_{B_0}(\vec K)$. The resulting expression for the noise power spectrum is
\begin{widetext}
\beq
P^N_{B_0}(\vec K) = \left(\frac{(2\pi)^3}{2V}\sum_{\vec k} \frac{\left|P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) - P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})\right|^2}{\left(G^2_0({\bf{\widehat k}})P_\delta(k) + P^N(\vec k)\right)\left(G^2_0({\bf{\widehat k'}})P_\delta(k') + P^N(\vec k')\right) } \right)^{-1},
\label{eq:NK}
\eeq
\end{widetext}

Note that only the components of $\vec B$ in the plane of the sky have an effect of the observed brightness temperature, and so the results derived in this Section hold only for those components. The noise in these two components is not correlated, and the noise in the direction along the line of sight can be considered infinite.

Finally, note that a similar type of estimator can be written down for the directions of the uniform magnetic field, and, in principle, used to recover the direction of the magnetic field in a certain patch of the sky. However, in this work we only focus on its magnitude.