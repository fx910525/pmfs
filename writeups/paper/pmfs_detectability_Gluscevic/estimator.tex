\section{Quadratic estimator formalism}
\label{sec:estimators}

We now derive an unbiased minimum--variance quadratic estimator for a magnetic field $\vec B$ present in the IGM prior to the epoch of reionization. This formalism is applicable to tomographic data from 21--cm surveys, and is similar to that used in CMB lensing analyses \cite{2003PhRvD..67h3002O}, for example. We assume that the magnetic field only evolves adiabatically, due to Hubble expansion, 
\beq
B(z) = B_0(1+z)^2,
\label{eq:B0}
\eeq
where $B_0$ is its present--day value (the value of the field in comoving units). The corresponding estimator is denoted with a hat sign, $\widehat B_0$. 

We start by noting that the observed brightness--temperature fluctuations $T(\vec k)$ contain contributions from the noise fluctuation $T^N(\vec k)$ (from the instrumental noise plus Galactic foreground emission\footnote{Note that this term adds variance to the visibilities due to foregrounds, but we assume the bias in the visibilities is removed via foreground cleaning.}) and the signal $T^S(\vec k)$, 
\beq
\bga
T(\vec k) = T^N(\vec k) + T^S(\vec k),
\ega
\label{eq:Ttot}
\eeq
where $T^S(\vec k)$ can get contribution from both the magnetic--field effects and the (null--case) cosmological 21--cm signal, $T^S_0(\vec k)$. The signal temperature fluctuation is proportional to the density fluctuation $\delta$, with transfer function $G({\bf{\widehat k}})$ as the proportionality factor, 
\beq
\bga
G({\bf{\widehat k}}) \equiv \frac{\partial T}{\partial\delta}({\bf{\widehat k}},\delta=0),
\ega
\eeq
and
\beq
\bga
T^S(\vec k) = G({\bf{\widehat k}})\delta(k),\\
T^S_0(\vec k) = G_0({\bf{\widehat k}})\delta(k),
\ega
\label{eq:def_G}
\eeq
where ${\bf{\widehat k}}=(\theta_k,\phi_k)$ is a unit vector in the direction of $\vec k$. Note that we use the subscript ``0'' to denote when the transfer function $G$, the temperature fluctuation $T$, their derivatives, or the power spectrum $P$, are evaluated at $B_0=0$. Furthermore, we omit explicit dependence of $G$ on redshift and on cosmological parameters, and consider it implied. Finally, note that $G$ is a function of the direction vector ${\bf{\widehat k}}$, while the power spectrum $P_\delta$ is a function of the magnitude $k$, in an isotropic universe. The expression for the transfer function is obtained from Eq.~(\ref{eq:tbsoln}),
\beq
\bga
G({\bf{\widehat k}})=\left( 1 - \frac{T_\gamma}{T_{\rm s}} \right) x_{1{\rm s}} \left( \frac{1+z}{10} \right)^{1/2} \\
\times \biggl[ 26.4 \ {\rm mK}  \left(1 + ({\bf{\widehat k}} \cdot {\bf{\widehat n}})^2 \right)  
- 0.128 \ {\rm mK} \left( \frac{T_\gamma}{T_{\rm s}} \right)\\
\times x_{1{\rm s}} \left( \frac{1+z}{10} \right)^{1/2}  
 \Bigl\{ 2 \left(1 + ({\bf{\widehat k}} \cdot {\bf{\widehat n}})^2 \right) \\
- \sum_m \frac{4\pi}{75} \frac{Y_{2 m}({\bf{\widehat k}}) \left[ Y_{2 m} ({\bf{\widehat n}}) \right]^* }{1 + x_{ \alpha, (2) } + x_{{\rm c}, (2)} - i m x_{\rm B}} \Bigr\} \biggr] ,
\label{eq:G_def}
\ega
\eeq
for a reference frame where the magnetic field is along the $z$--axis.
For simplicity of the expressions, we adopt the following notation
\beq
\bga
\frac{\partial T_0^S}{\partial B_0}(\vec k)\equiv  \delta(k)\frac{\partial G}{\partial B_0}({\bf{\widehat k}},B_0=0),\\
\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})\equiv\frac{\partial G}{\partial B_0}({\bf{\widehat k}},B_0=0),
\ega
\label{eq:dTdB_dGdB}
\eeq
where $\frac{\partial G_0}{\partial B_0}=\frac{\partial G_0}{\partial B} (1+z)^2$ for adiabatic evolution of the magnetic field. 

The signal power spectrum in the absence of a magnetic field (null case) is given by
\beq
\bga
\left<T_0(\vec k)T_0^*(\vec k')\right> \equiv (2\pi)^3 \delta_D(\vec k-\vec k') P_0^S(\vec k)\\
= (2\pi)^3 \delta_D(\vec k-\vec k')G^2_0({\bf{\widehat k}})P_\delta(k),
\ega
\eeq
where 
\beq
\bga
\left<\delta(\vec k)\delta^*(\vec k')\right> \equiv (2\pi)^3 \delta_D(\vec k-\vec k') P_\delta(k).
\ega
\label{eq:Pdelta_definition}
\eeq
The total measured null--case power spectrum is
\beq
P_\text{null}(\vec k) \equiv P^N(\vec k) + P_0^S(\vec k).
\label{eq:Pnull}
\eeq

In \S\ref{subsec:uniform}, we first consider the case of a field uniform in the entire survey volume; this case is described by a single parameter, $B_0$. In \S\ref{subsec:SI}, we move on to the case of a stochastic magnetic field, with a given power spectrum $P_B(\vec K)$ (where $\vec K$ is the wavevector of a given mode of the field); in this case, the relevant parameter is the amplitude of this power spectrum, $ A_0^2$. In both cases, we assume that there is a valid separation of scales: density--field modes in consideration must have much smaller wavelengths than the coherence scale of the magnetic field (or a given mode wavelength for the case of a stochastic magnetic field), and both length scales must fit within the size of the survey.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Uniform field}
\label{subsec:uniform}

We now derive an estimator $\widehat B_0$ for a comoving uniform magnetic field. We adopt the linear--theory approach and start with
\beq
\bga
T^S(\vec k) = T^S_0(\vec k) + B_0\frac{\partial T^S_0}{\partial B_0}(\vec k),
\ega
\label{eq:TS_uniform}
\eeq
where $B_0$ is a small expansion parameter. The observable two--point correlation function in Fourier space is then
\beq
\bga
\langle T(\vec k)T^*(\vec k')\rangle = P_\text{null}(\vec k)(2\pi)^3\delta_D(\vec k-\vec k') \\
+ \langle T^S_0(\vec k)B_0\frac{\partial T_0^{S,*}}{\partial B_0}(\vec k')\rangle + \langle T_0^{S,*}(\vec k')B_0\frac{\partial T_0^S}{\partial B_0}(\vec k)\rangle\\
=\left(P_\text{null}(\vec k)
 + 2B_0P_{\delta}( k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}}) \right) \\\times(2\pi)^3\delta_D(\vec k-\vec k'),
\ega
\label{eq:TT_step2}
\eeq
where we use the reality of $G_0$ and $\frac{\partial G_0}{\partial B_0}$, assume that the signal and the noise are uncorrelated, and keep only terms linear in $B_0$. Since we observe only one universe, a proxy for the ensemble average in \eq{\ref{eq:TT_step2}} is measurement of the product $T(\vec k)T^*(\vec k)$. Thus, an estimate of $B_0$ from a single temperature mode $\vec k$ is
\beq
\widehat B_0^{\vec k} = \frac{\frac{1}{V}T(\vec k)T^*(\vec k) - P_\text{null}(\vec k)}{2P_{\delta}( k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})},
\label{eq:hatBk}
\eeq 
where we use the following properties of the Dirac delta function (defined on a finite volume $V$ of the survey)
\beq
\bga
\delta_D(\vec k-\vec k') = \frac{V}{(2\pi)^3},\hspace{0.2in} \text{for }\vec k = \vec k',\\
(2\pi)^3\delta_D(\vec k - \vec k') \equiv \int e^{-i\vec r \cdot (\vec k-\vec k')}d\vec r,
\ega
\label{eq:delta_kk}
\eeq
which is related to the Kronecker delta as
\beq
\delta_{\vec k\vec k'} = \frac{(2\pi)^3}{V}\delta_D(\vec k-\vec k').
\label{eq:deltas}
\eeq

The estimator of \eq{\ref{eq:hatBk}} is unbiased (with a zero mean), $\langle \widehat B_0^{\vec k}\rangle=0$. The covariance $\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k'},*}\rangle $ of estimators derived from all measured temperature modes involves temperature--field four--point correlation function with three Wick contractions, whose numerator reads
\beq
\bga
\frac{1}{V^2}\langle T(\vec k)T^*(\vec k)T(\vec k')T^*(\vec k') \rangle + P_\text{null}(\vec k)P_\text{null}(\vec k')\\
- \frac{1}{V}P_\text{null}(\vec k)\langle T(\vec k')T^*(\vec k') \rangle
- \frac{1}{V}P_\text{null}(\vec k')\langle T(\vec k)T^*(\vec k) \rangle \\
= P_\text{null}(\vec k)P_\text{null}(\vec k') \left[\frac{(2\pi)^6}{V^2}\right.\delta_D(\vec k-\vec k)\delta_D(\vec k'-\vec k')\\
+\frac{(2\pi)^6}{V^2}\delta_D(\vec k-\vec k')\delta_D(\vec k-\vec k')+
\frac{(2\pi)^6}{V^2}\delta_D(\vec k+\vec k')\delta_D(\vec k+\vec k')\\
-\frac{(2\pi)^3}{V}\delta_D(\vec k'-\vec k')-\left.\frac{(2\pi)^3}{V}\delta_D(\vec k-\vec k)\right]\\
=P_\text{null}(\vec k)P_\text{null}(\vec k')\left(\delta_{\vec k,\vec k'} + \delta_{\vec k,-\vec k'}\right),
\ega
\label{eq:TTTT_expansion}
\eeq
where every ensemble average yielded one factor of volume $V$. Using the final expression in the above Equation, we get  
\beq
\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k'},*}\rangle = \frac{P_\text{null}^2(\vec k)\left(\delta_{\vec k,\vec k'}  + \delta_{\vec k,-\vec k'} \right)}{4P_{\delta}( k)^2\left[G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})\right]^2}.
\label{eq:B_covariance}
\eeq
Estimators from all $\vec k$--modes can be combined with inverse--variance weighting as
\beq
\bga
\widehat B_0 = \frac{\sum_{\vec k}\frac{\widehat B_0^{\vec k}}{\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k},*}\rangle}}{\sum_{\vec k}\frac{1}{\langle \widehat B_0^{\vec k}\widehat B_0^{{\vec k},*}\rangle}}.
\ega
\label{eq:B_mve}
\eeq 
Expanding the above expression, we get the minimum--variance quadratic estimator for $B_0$ obtained from all temperature--fluctuation modes  observed at a given redshift, 
\beq
\bga
\widehat B_0 = \sigma^{2}_{ B_0}\sum_{\vec k}\frac{\frac{1}{V}T(\vec k)T^*(\vec k) - P_\text{null}(\vec k)}{P_\text{null}^2(\vec k)}\\
\times 2P_{\delta}( k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}}).
\ega
\label{eq:B_estimator}
\eeq
Its variance $\sigma^{2}_{ B_0}$ is given by
\beq
\bga
\sigma^{-2}_{ B_0} = \frac{1}{2}\sum_{\vec k}\left(\frac{2P_{\delta}(k)G_0({\bf{\widehat k}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k}})}{P_\text{null}(\vec k)}\right)^{2},
\ega
\label{eq:B_estimator_var}
\eeq
where the sums are unrestricted. Note that $\widehat B_0^{\vec k}=\widehat B_0^{-\vec k}$; this follows from the reality condition on the temperature field, $T(\vec k)=T^*(-\vec k)$, and from the isotropy of space in the null--assumption case, $G_0({\bf{\widehat k}})=G_0(-{\bf{\widehat k}})$. Thus, in order to avoid double counting of modes, a factor of $1/2$ appears at the right--hand side of Eq.~(\ref{eq:B_estimator_var}).

Finally, the total sensitivity of a survey covering a range of redshifts is given by integrating the above Equation as
\beq
\bga
\sigma_{ B_0,\text{tot}}^{-2} = 
\frac{1}{2}\int dV_\mathrm{}(z)
\frac{k^2dk d\phi_k\sin \theta_kd\theta_k}{(2\pi)^3}\\
\times\left( \frac{2P_\delta(k,z)G_0(\theta_k,\phi_k,z)\frac{\partial G_0}{\partial B_0}(\theta_k, \phi_k,z)}{P^N(k,\theta_k,z) + P_\delta(k,z)G_0^2(\theta_k,\phi_k,z)} \right)^2,
\ega
\label{eq:fisher_patch}
\eeq
where we transitioned from a sum over $\vec k$ modes to an integral, using $\sum_{\vec k} \to V\int d\vec k /(2\pi)^3$. 
The integral is performed over the (comoving) volume of the survey of angular size $\Omega_\mathrm{survey}$ (at a given redshift, given in steradians), such that the volume element reads
\beq
dV_\mathrm{} = \frac{c}{H(z)}\chi^2(z)\Omega_\mathrm{survey}dz.
\label{eq:dVpatch}
\eeq

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Stochastic field}
\label{subsec:SI}

We now examine the case where both the magnitude and the direction of the magnetic field are stochastic random variables, with spatial variation. Note that in this Section we do \textit{not} assume a particular model for their power spectra, but we do assume a separation of scales, in the sense that we are only concerned with the modes $\vec K$ of the magnetic field that correspond to scales much larger than those corresponding to the density and temperature modes used for estimating the field, $|\vec K|\ll|\vec k|,|\vec k'|$. We use $B_0$ to denote a component of the magnetic field along one of the three Cartesian--system axes, and $\vec r$ to denote position vector in physical space, as before, and start with 
\beq
T(\vec r) = T^S_0(\vec r) + B_0(\vec r)\frac{\partial T^S_0}{\partial B_0}(\vec r),
\eeq
where the subscripts and superscripts have the same meaning as before. In Fourier space, we now get
\beq
\bga
T(\vec k) = T^S_0(\vec k) + \int d\vec r e^{-i\vec k \cdot \vec r} B_0(\vec r) \frac{\partial T^S_0}{\partial B_0}(\vec r)\\
= T^S_0(\vec k) + \frac{1}{(2\pi)^3}\int d\vec k_1B_0(\vec k_1) \frac{\partial T^S_0}{\partial B_0}(\vec k-\vec k_1),
\ega
\eeq
where the last step uses the convolution theorem. The observable two--point correlation function in Fourier space then becomes
\beq
\bga
\left < T(\vec k)T^*(\vec k')\right > = (2\pi)^3\delta_D(\vec k-\vec k')P_\text{null}(\vec k)\\
+ \left <T_0^{S,*}(\vec k')\frac{1}{(2\pi)^3}\int d\vec k_1 B_0(\vec k_1) \frac{\partial T^S_0}{\partial B_0}(\vec k-\vec k_1)\right > \\
+ \left <T^S_0(\vec k)\frac{1}{(2\pi)^3}\int d\vec k_1 B_0^*(\vec k_1) \left(\frac{\partial T^S_0}{\partial B_0}(\vec k'-\vec k_1)\right)^*\right >, 
\ega
\eeq
to first order in $B_0$. Note that, in this case, there is cross--mixing of different modes of the temperature field. From Eqs.~(\ref{eq:def_G}), (\ref{eq:dTdB_dGdB}), and (\ref{eq:Pdelta_definition}), we get
\beq
\bga
\left< T(\vec k)T^*(\vec k')\right> = (2\pi)^3\delta_D(\vec k - \vec k')  P_\text{null}(\vec k)+B_0(\vec k - \vec k')\\
\times\left[ P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) + P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})\right],
\ega
\eeq
where we used the reality condition $B_0^*(-\vec K) = B_0(\vec K)$. In analogy to the procedure of \S\ref{subsec:uniform}, we estimate $B_0(\vec K)$ from $\vec k\vec k'$ pair of modes that satisfy $\vec K=\vec k-\vec k'$ as
\beq
\widehat B_0^{\vec k\vec k'}(\vec K) = \frac{T(\vec k)T^*(\vec k')}{P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) + P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})},
\label{eq:Bkkp_estimator}
\eeq
where we only focus on terms $\vec K\ne0$ ($\vec k \ne\vec k'$).
The variance $\left< \widehat B_0^{\vec k\vec k'}(\vec K)\left(\widehat B_0^{\vec k\vec k'}(\vec K')\right)^*\right>$ of this estimator (under the null assumption) can be evaluated using the above expression. Furthermore, the full estimator for $B_0(\vec K)$ from all available temperature modes is obtained by combining individual $\widehat B_0^{\vec k\vec k'}(\vec K)$ estimates with inverse--variance weights, and with appropriate normalization, in complete analogy to the uniform--field case. For the purpose of forecasting sensitivities, we are interested in the variance of the minimum--variance estimator, or equivalently, the noise power spectrum $P^N_{B_0}(\vec K)$, given by
\beq
\bga
(2\pi)^3\delta_D(\vec K - \vec K') P^N_{B_0}(\vec K) \equiv \left< \widehat B_0(\vec K)\widehat B_0(\vec K')^*\right>\\
= \left( \sum_{\vec k} \frac{\left(P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) + P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})\right)^2}{2V^2P_\text{null}(\vec k) P_\text{null}(\vec k')} \right)^{-1},
\ega
\label{eq:NK1}
\eeq
with the restriction $\vec K=\vec k-\vec k'$. The factor of $2$ in the denominator corrects for double counting mode pairs, since $\widehat B_0^{\vec k\vec k'}(\vec K)=\left(\widehat B_0^{-\vec k-\vec k'}(\vec K)\right)^*$, and the sum is unconstrained. If we only consider diagonal terms $\vec K=\vec K'$, then the left--hand side of the above Equation becomes equal to $V P^N_{B_0}(\vec K)$. The explicit expression for the noise power spectrum is then
\beq
\bga
P^N_{B_0}(\vec K) = \\
\left(\sum_{\vec k} \frac{\left(P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_0}({\bf{\widehat k'}}) + P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_0}({\bf{\widehat k}})\right)^2}{2VP_\text{null}(\vec k) P_\text{null}(\vec k')  } \right)^{-1}.
\label{eq:NK}
\ega
\eeq

Finally, transitioning from a sum to the integral (like in \S\ref{subsec:uniform_fisher}), we get the following expression for the noise power spectrum of one of the components $B_{0,i}$ of the magnetic field in the plane of the sky,
\beq
\bga
\left(P^N_{B_{0,i}}(\vec K)\right)^{-1} = \int k^2d{k}\sin \theta_kd\theta_kd\phi_k \\
\times\frac{\left(P_\delta(k')G_0^*({\bf{\widehat k'}})\frac{\partial G_0}{\partial B_i}({\bf{\widehat k'}}) + P_\delta(k)G_0({\bf{\widehat k}})\frac{\partial G_0^*}{\partial B_i}({\bf{\widehat k}})\right)^2}{2(2\pi)^3P_\text{null}(\vec k) P_\text{null}(\vec k') } ,
\ega
\label{eq:NK2}
\eeq
where $\vec k'=\vec K -\vec k$ and the above expression is evaluated at a particular redshift. Only the components of the magnetic field in the plane of the sky affect the observed brightness--temperature fluctuations, and so Eq.~(\ref{eq:NK2}) can be used to evaluate the noise power spectrum for either one of the two (uncorrelated) components. The noise in the direction along the line of sight can be considered infinite. Finally, note that we can construct a similar estimator for the direction of the magnetic field in a given patch of the sky. However, in this work we focus on the magnitude of the field and ignore considerations with regard to its direction.